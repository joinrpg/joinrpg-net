# Notifications

Сейчас система выглядит так:
1. Доменный сервис вызывает EmailService, в котором описаны все возможные email, передает ему бизнес-сущности DataModel
1. Тот собирает все нужные данные, подписки и формирует шаблон mailgun, в который в качестве переменных передаются все нужные поля, которые изменяются для каждого получателя, например имя, измененные поля (т.к. не все видят)
1. Дальше через Common.EmailSending → Mailgun_csharp письмо уходит в mailgun, там шаблонизируется, ставится в очередь и отправляется получателям.

## Проблемы

1. Шаблон накладывается на стороне mailgun, соответственно нам нужно самостоятельно реализовать шаблонизацию, чтобы отправлять все в телегу
1. Нам нужно отказаться от mailgun (иностранный сервис, а аналог например в Яндексе, не предусматривают шаблонизацию, просто позволяет поставить одно письмо в очередь)

## Решение
1. Создаем сервис Notifications. Он принимает на вход сообщение-шаблон + id пользователей, кому отослать + поля для них. Шаблонизирует, загружает настройки отправления в , и записывает в БД записи (1 ряд = 1 сообщение 1 пользователю по 1 каналу связи).
1. Пока что реализуем один канал - inbox пользователя, на нем отрабатываем все, а также старую отсылку через mailgun (по прежнему на стороне сервиса)
1. Переключаем все на новый интерфес (Notifications) вместо Common.EmailSending. Убеждаемся, что новая шаблонизация прилично работает.
1. Добавляем джобу, которая реализует отсылку через телегу, добавляем телегу в список каналов, делаем у пользователя настройку через что отправлять (через телегу, через email, оба способа). Привязка аккаунта к телеге и получение разрешения на отправку сообщений от бота уже реализовано
1. Переключаем отправку email вместо шаблонизации на стороне mailgun на нашу шаблонизацию.
1. Меняем отсылку email вместо mailgun на яндексовский сервис без шаблонизации.
